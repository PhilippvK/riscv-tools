name: RISC-V GNU Toolchain Builds

on:
  workflow_dispatch:
    inputs:
      config:
        type: string
        description: Which config to use
        required: true
        default: .github/build_commands.json

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  parse-metadata:
    runs-on: ubuntu-latest
    outputs:
      releases: ${{ steps.parse.outputs.releases }}
    steps:
      - uses: actions/checkout@v4
      - id: parse
        run: |
          releases=$(jq -c '.releases' ${{ github.event.inputs.config }})
          echo "releases=$releases" >> $GITHUB_OUTPUT
  create-releases:
    needs: parse-metadata
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        release: ${{ fromJson(needs.parse-metadata.outputs.releases) }}
    steps:
      - uses: actions/checkout@v4
      - name: Ensure release exists
        run: |
          tag="${{ matrix.release.tag }}"
          title="${{ matrix.release.title }}"
          if ! gh release view "$tag" &>/dev/null; then
            echo "Creating release $tag"
            gh release create "$tag" --title "$title" --notes ""
          else
            echo "Release $tag already exists"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  expand-commands:
    needs: parse-metadata
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.expand.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: expand
        run: |
          releases='${{ needs.parse-metadata.outputs.releases }}'
          # build [{ "release": {...}, "command": "..."}, ...]
          matrix=$(echo "$releases" | jq -c '[.[] | {release: ., commands: .commands} | .commands[] as $c | {release: {tag: .release.tag, title: .release.title, dest: .release.dest}, command: $c}]')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build:
    needs: [create-releases, expand-commands]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.expand-commands.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Get image os
        id: os
        run: |
          OS=$(echo "${{ matrix.command }}" | sed -n 's/.*\(ubuntu-[0-9]*\.[0-9]*\).*/\1/p')
          echo "os=$OS"
          echo "os=$OS" >> "$GITHUB_OUTPUT"
      - name: Get command hash
        id: hash
        run: |
          HASH=$(echo -n "${{ matrix.command }}" | md5sum | cut -f1 -d' ')
          echo "hash=$HASH"
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
      - name: Get Tags
        id: tags
        run: |
          TAG0=$(echo "${{ matrix.release.tag }}" | cut -d_ -f1)
          TAG1=$(echo "${{ matrix.release.tag }}" | cut -d_ -f2-)
          echo "tag0=$TAG0"
          echo "tag1=$TAG1"
          echo "tag0=$TAG0" >> "$GITHUB_OUTPUT"
          echo "tag1=$TAG1" >> "$GITHUB_OUTPUT"
      - name: ccache cache files
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ steps.os.outputs.os }}-${{ steps.tags.outputs.tag0 }}-${{ steps.tags.outputs.tag1 }}-${{ steps.hash.outputs.hash }}-${{ steps.date.outputs.date }}
          restore-keys: |
              ccache-${{ steps.os.outputs.os }}-${{ steps.tags.outputs.tag0 }}-${{ steps.tags.outputs.tag1 }}-${{ steps.hash.outputs.hash }}
              ccache-${{ steps.os.outputs.os }}-${{ steps.tags.outputs.tag0 }}-${{ steps.tags.outputs.tag1 }}
              ccache-${{ steps.os.outputs.os }}-${{ steps.tags.outputs.tag0 }}
              ccache-${{ steps.os.outputs.os }}
      - name: Prepare Shared CCache dir
        run: |
          sudo apt -qq update
          sudo apt -qq install -yy ccache
          export CCACHE_DIR=$(pwd)/.ccache
          mkdir -p $CCACHE_DIR
          ccache -M 8G
          echo "absolute_paths_in_stderr = true" >> $CCACHE_DIR/ccache.conf
          echo "compression = true" >> $CCACHE_DIR/ccache.conf
      - name: Run build command
        run: |
          echo "Executing: ${{ matrix.command }}"
          bash -c "${{ matrix.command }}"

      - name: Upload artifacts to release
        run: |
          gh release upload ${{ matrix.release.tag }} ${{ matrix.release.dest }}/*.tar.xz --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
